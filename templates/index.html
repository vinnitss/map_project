<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Map</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey={{ api_key }}" type="text/javascript"></script>
    <style>
        #map { width: 100%; height: 90vh; }
        .filters { margin: 10px; }
        .filter-button { margin-right: 10px; }
    </style>
</head>
<body>
    <h1>Объекты строительства</h1>

    <div class="filters">
        <button class="filter-button" onclick="applyFilter('active')">Активные</button>
        <button class="filter-button" onclick="applyFilter('delayed')">Задержанные</button>
        <button class="filter-button" onclick="applyFilter('stopped')">Остановленные</button>
        <button class="filter-button" onclick="resetFilters()">Сбросить фильтры</button>
    </div>

    <div id="map"></div>

    <script>
        let filteredObjects = [];

        ymaps.ready(init);

        function init() {
            const map = new ymaps.Map('map', {
                center: [{{ map_center.lat }}, {{ map_center.lon }}],
                zoom: 10,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });

            fetch('/api/objects')
                .then(response => response.json())
                .then(data => {
                    filteredObjects = data;
                    updateMap(map, filteredObjects);
                });
        }

        function updateMap(map, objects) {
            map.geoObjects.removeAll();
            objects.forEach(obj => {
                const placemark = new ymaps.Placemark([obj.lat, obj.lon], {
                    balloonContentHeader: obj.name,
                    balloonContentBody: obj.info,
                    balloonContentFooter: `<a href="/object/${obj.id}">Подробнее</a>`
                }, {
                    preset: getPresetByStatus(obj.status)
                });
                map.geoObjects.add(placemark);
            });
        }

        function getPresetByStatus(status) {
            switch (status.toLowerCase()) {
                case 'active': return 'islands#greenDotIcon';
                case 'delayed': return 'islands#yellowDotIcon';
                case 'stopped': return 'islands#redDotIcon';
                default: return 'islands#grayDotIcon';
            }
        }

        function applyFilter(status) {
            const filtered = filteredObjects.filter(obj => obj.status.toLowerCase() === status.toLowerCase());
            updateMap(map, filtered);
        }

        function resetFilters() {
            updateMap(map, filteredObjects);
        }
    </script>
</body>
</html>
