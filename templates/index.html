<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Construction Map</title>
    <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&amp;apikey={{ api_key }}" type="text/javascript"></script>
    <style>
        #map { width: 100%; height: 90vh; }
    </style>
</head>
<body>
    <h1>Объекты строительства</h1>
    <div id="map"></div>

    <script>
        ymaps.ready(init);
        function init() {
            const map = new ymaps.Map('map', {
                center: [{{ map_center.lat }}, {{ map_center.lon }}],
                zoom: 10,
                controls: ['zoomControl', 'typeSelector', 'fullscreenControl']
            });

            fetch('/api/objects')
                .then(response => response.json())
                .then(data => {
                    data.forEach(obj => {
                        const currentTime = new Date().toLocaleString('ru-RU', {
                            timeZone: getTimezoneFromCoords(obj.lat, obj.lon),
                            hour: '2-digit',
                            minute: '2-digit',
                            timeZoneName: 'short'
                        });

                        const placemark = new ymaps.Placemark([obj.lat, obj.lon], {
                            balloonContentHeader: obj.name,
                            balloonContentBody: `${obj.info}<br><strong>Текущее время:</strong> ${currentTime}`,
                            balloonContentFooter: `<a href="/object/${obj.id}">Подробнее</a>`
                        }, {
                            preset: getPresetByStatus(obj.status)
                        });
                        map.geoObjects.add(placemark);
                    });
                });
        }

        function getPresetByStatus(status) {
            switch (status.toLowerCase()) {
                case 'active': return 'islands#greenDotIcon';
                case 'delayed': return 'islands#yellowDotIcon';
                case 'stopped': return 'islands#redDotIcon';
                default: return 'islands#grayDotIcon';
            }
        }

        function getTimezoneFromCoords(lat, lon) {
            const timezones = [
                { lon: 180, tz: 'Asia/Kamchatka' },
                { lon: 160, tz: 'Asia/Magadan' },
                { lon: 150, tz: 'Asia/Vladivostok' },
                { lon: 135, tz: 'Asia/Yakutsk' },
                { lon: 120, tz: 'Asia/Irkutsk' },
                { lon: 105, tz: 'Asia/Krasnoyarsk' },
                { lon: 90,  tz: 'Asia/Novosibirsk' },
                { lon: 75,  tz: 'Asia/Yekaterinburg' },
                { lon: 60,  tz: 'Europe/Moscow' },
                { lon: 30,  tz: 'Europe/Kaliningrad' },
                { lon: 0,   tz: 'Europe/London' },
                { lon: -30, tz: 'Atlantic/Azores' }
            ];

            for (let i = 0; i < timezones.length; i++) {
                if (lon >= timezones[i].lon) {
                    return timezones[i].tz;
                }
            }
            return 'Europe/Moscow';
        }
    </script>
</body>
</html>
